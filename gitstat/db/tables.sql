CREATE TABLE USERS
(
    id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    username VARCHAR2(200) UNIQUE NOT NULL,
    email VARCHAR2(400) UNIQUE NOT NULL,
    password_hash VARCHAR2(255) NOT NULL,
    role VARCHAR2(150) DEFAULT 'user' NOT NULL CHECK (role IN ('user', 'admin', 'moderator')),
    is_blocked char(1) DEFAULT 'N' CHECK (is_blocked IN ('Y', 'N')),
    created_at TIMESTAMP DEFAULT CURRENT_DATE
)

CREATE TABLE PROFILES
(
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    git_id NUMBER NOT NULL UNIQUE,
    login VARCHAR2(100),
    avatar_url VARCHAR2(255),
    html_url VARCHAR2(255),
    type VARCHAR2(20) DEFAULT 'User',
    name VARCHAR2(200),
    company VARCHAR2(200),
    location VARCHAR(200),
    email VARCHAR2(200),
    blog VARCHAR2(500),
    bio VARCHAR2(4000),
    twitter_username VARCHAR2(100),
    followers_count NUMBER DEFAULT 0,
    following_count NUMBER DEFAULT 0,
    public_repos NUMBER DEFAULT 0,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
)

CREATE TABLE REPOSITORIES
(
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    git_id NUMBER NOT NULL UNIQUE,
    name VARCHAR2(200) NOT NULL,
    owner_git_id NUMBER NOT NULL REFERENCES PROFILES(git_id),
    html_url VARCHAR2(200) NOT NULL,
    description VARCHAR2(1000),
    repo_size NUMBER,
    stars NUMBER,
    forks NUMBER,
    default_branch VARCHAR2(20) DEFAULT 'main',
    open_issues NUMBER,
    subscribers_count NUMBER,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    pushed_at TIMESTAMP
)

CREATE TABLE REQUEST_HISTORY
(
    id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    user_id NUMBER NOT NULL REFERENCES USERS (id) ON DELETE CASCADE,
    repository_id NUMBER DEFAULT NULL REFERENCES REPOSITORIES (git_id) ON DELETE CASCADE,
    profile_id NUMBER DEFAULT NULL REFERENCES PROFILES (git_id) ON DELETE CASCADE,
    request_time TIMESTAMP DEFAULT CURRENT_DATE,
    request_type VARCHAR2(20) DEFAULT 'REPOSITORY' CHECK (request_type IN ('REPOSITORY', 'PROFILE')),

    CONSTRAINT exactly_one CHECK
    (
    (repository_id IS NOT NULL AND profile_id IS NULL)
    OR
    (repository_id IS NULL AND profile_id IS NOT NULL)
    )
)

CREATE TABLE REPOSITORY_LANGUAGES
(
    id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    repository_id NUMBER NOT NULL REFERENCES REPOSITORIES(git_id) ON DELETE CASCADE,
    language VARCHAR2(200) NOT NULL,
    bytes_count NUMBER DEFAULT 0
)

CREATE TABLE REPOSITORY_TOPICS
(
    id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    repository_id NUMBER NOT NULL REFERENCES REPOSITORIES(git_id) ON DELETE CASCADE,
    topic VARCHAR2(200) NOT NULL
)

CREATE TABLE REPOSITORY_LICENSES
(
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    repository_id NUMBER NOT NULL REFERENCES repositories(git_id) ON DELETE CASCADE,
    license_name VARCHAR2(200),
    spdx_id VARCHAR2(50)
);

CREATE TABLE COMMITS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    repository_id NUMBER NOT NULL REFERENCES repositories(git_id) ON DELETE CASCADE,
    sha VARCHAR2(50) NOT NULL UNIQUE,
    author_login VARCHAR2(100),
    author_avatar_url VARCHAR2(255),
    commit_date TIMESTAMP,
    url VARCHAR2(255)
);

CREATE INDEX idx_commit_repo_id ON COMMITS(repository_id);

TRUNCATE TABLE REQUEST_HISTORY;
TRUNCATE TABLE REPOSITORIES;
TRUNCATE TABLE PROFILES;
TRUNCATE TABLE COMMITS;
TRUNCATE TABLE REPOSITORY_LICENSES;
TRUNCATE TABLE USERS;

DROP TABLE USERS;
DROP TABLE PROFILES;
DROP TABLE REQUEST_HISTORY;
DROP TABLE REPOSITORY_LANGUAGES;
DROP TABLE REPOSITORY_TOPICS;
DROP TABLE REPOSITORY_LICENSES;
DROP TABLE COMMITS;
DROP TABLE REPOSITORIES;

SELECT constraint_name, delete_rule, table_name
FROM user_constraints
WHERE r_constraint_name IN (
    SELECT constraint_name 
    FROM user_constraints 
    WHERE table_name = 'USERS' AND constraint_type = 'P'
)
AND table_name = 'REQUEST_HISTORY';

DELETE FROM USERS;
DELETE FROM REPOSITORIES;
DELETE FROM PROFILES;
DELETE FROM REQUEST_HISTORY;
COMMIT;